// test-cases/specs/commands/mv/debian-compliant.test.js
// Tests exhaustifs de conformit√© Debian pour la commande mv

import { createTestContext, clearCaptures, getCaptures } from '../../../lib/context.js';
import { assert, validateFileSystem, testUtils } from '../../../lib/helpers.js';
import { createTest } from '../../../lib/runner.js';
import { cmdMv } from '../../../../bin/mv/mv.js';
import { cmdMkdir } from '../../../../bin/mkdir/mkdir.js';
import { cmdTouch } from '../../../../bin/touch.js';
import { cmdUseradd } from '../../../../bin/useradd.js';
import { cmdSu } from '../../../../bin/su.js';
import { cmdChmod } from '../../../../bin/chmod.js';
import { clearUserStack } from '../../../../modules/users/user-stack.js';
import { FileSystemService } from '../../../../modules/filesystem/index.js';

/**
 * Fonction utilitaire pour v√©rifier qu'un mv a r√©ussi silencieusement
 */
function assertMvSuccess(captures, description) {
    assert.captureCount(0, `${description} - mv doit √™tre silencieux en cas de succ√®s (comportement Debian)`);
}

/**
 * Fonction utilitaire pour v√©rifier les messages d'erreur fran√ßais
 */
function assertMvError(captures, expectedErrorPattern, description) {
    assert.isTrue(captures.length > 0, `${description} - mv doit afficher une erreur`);
    
    // Debug: afficher les messages captur√©s pour diagnostic
    console.log(`üîç DEBUG ${description}:`);
    captures.forEach((capture, index) => {
        console.log(`  [${index}] ${capture.className}: "${capture.text}"`);
    });
    
    const errorFound = captures.some(capture => 
        capture.className === 'error' && 
        capture.text.match(expectedErrorPattern)
    );
    
    if (!errorFound) {
        console.log(`‚ùå Pattern attendu: ${expectedErrorPattern}`);
        console.log(`‚ùå Messages d'erreur trouv√©s: ${captures.filter(c => c.className === 'error').map(c => c.text).join(', ')}`);
    }
    
    assert.isTrue(errorFound, `${description} - le message d'erreur doit correspondre au pattern: ${expectedErrorPattern}`);
}

/**
 * TEST 1: Renommage simple de fichier (comportement de base Debian)
 */
function testDebianSimpleRename() {
    console.log('üß™ TEST DEBIAN: Renommage simple de fichier');
    
    clearCaptures();
    const context = createTestContext();
    
    // Cr√©er un fichier test
    testUtils.createTestFile(context, '/root/oldname.txt', 'contenu test');
    assert.fileExists(context, '/root/oldname.txt', 'Le fichier source doit exister');
    
    // Renommer le fichier
    cmdMv(['oldname.txt', 'newname.txt'], context);
    
    // COMPORTEMENT DEBIAN: Aucune sortie en cas de succ√®s
    const captures = getCaptures();
    assertMvSuccess(captures, 'Renommage simple');
    
    // V√©rifications post-mv
    assert.fileNotExists(context, '/root/oldname.txt', 'L\'ancien fichier ne doit plus exister');
    assert.fileExists(context, '/root/newname.txt', 'Le nouveau fichier doit exister');
    assert.isFile(context, '/root/newname.txt', 'Doit rester un fichier');
    
    // V√©rifier que le contenu est pr√©serv√©
    const file = context.fileSystem['/root/newname.txt'];
    assert.equals(file.content, 'contenu test', 'Le contenu doit √™tre pr√©serv√©');
    
    console.log('‚úÖ DEBIAN CONFORME: Renommage simple silencieux');
    return true;
}

/**
 * TEST 2: D√©placement d'un fichier vers un r√©pertoire existant
 */
function testDebianMoveFileToDirectory() {
    console.log('üß™ TEST DEBIAN: D√©placement de fichier vers r√©pertoire');
    
    clearCaptures();
    const context = createTestContext();
    
    // Cr√©er un fichier et un r√©pertoire
    testUtils.createTestFile(context, '/root/file.txt', 'contenu fichier');
    testUtils.createTestDirectory(context, '/root/target-dir');
    
    // D√©placer le fichier vers le r√©pertoire
    cmdMv(['file.txt', 'target-dir'], context);
    
    // COMPORTEMENT DEBIAN: Silencieux en cas de succ√®s
    const captures = getCaptures();
    assertMvSuccess(captures, 'D√©placement vers r√©pertoire');
    
    // V√©rifications
    assert.fileNotExists(context, '/root/file.txt', 'Le fichier source ne doit plus exister');
    assert.fileExists(context, '/root/target-dir/file.txt', 'Le fichier doit √™tre dans le r√©pertoire destination');
    assert.isFile(context, '/root/target-dir/file.txt', 'Doit rester un fichier');
    
    // V√©rifier le contenu pr√©serv√©
    const file = context.fileSystem['/root/target-dir/file.txt'];
    assert.equals(file.content, 'contenu fichier', 'Le contenu doit √™tre pr√©serv√©');
    
    console.log('‚úÖ DEBIAN CONFORME: D√©placement vers r√©pertoire');
    return true;
}

/**
 * TEST 3: D√©placement d'un r√©pertoire entier
 */
function testDebianMoveDirectory() {
    console.log('üß™ TEST DEBIAN: D√©placement de r√©pertoire entier');
    
    clearCaptures();
    const context = createTestContext();
    
    // Cr√©er un r√©pertoire avec contenu
    testUtils.createTestDirectory(context, '/root/source-dir');
    testUtils.createTestFile(context, '/root/source-dir/file1.txt', 'contenu 1');
    testUtils.createTestFile(context, '/root/source-dir/file2.txt', 'contenu 2');
    testUtils.createTestDirectory(context, '/root/source-dir/subdir');
    testUtils.createTestFile(context, '/root/source-dir/subdir/nested.txt', 'contenu nested');
    
    // Renommer le r√©pertoire
    cmdMv(['source-dir', 'renamed-dir'], context);
    
    // COMPORTEMENT DEBIAN: Silencieux
    const captures = getCaptures();
    assertMvSuccess(captures, 'D√©placement de r√©pertoire');
    
    // V√©rifications structure
    assert.fileNotExists(context, '/root/source-dir', 'L\'ancien r√©pertoire ne doit plus exister');
    assert.fileExists(context, '/root/renamed-dir', 'Le nouveau r√©pertoire doit exister');
    assert.isDirectory(context, '/root/renamed-dir', 'Doit rester un r√©pertoire');
    
    // V√©rifier que tout le contenu a √©t√© d√©plac√©
    assert.fileExists(context, '/root/renamed-dir/file1.txt', 'file1.txt doit √™tre d√©plac√©');
    assert.fileExists(context, '/root/renamed-dir/file2.txt', 'file2.txt doit √™tre d√©plac√©');
    assert.fileExists(context, '/root/renamed-dir/subdir', 'subdir doit √™tre d√©plac√©');
    assert.fileExists(context, '/root/renamed-dir/subdir/nested.txt', 'nested.txt doit √™tre d√©plac√©');
    
    // V√©rifier les contenus
    assert.equals(context.fileSystem['/root/renamed-dir/file1.txt'].content, 'contenu 1');
    assert.equals(context.fileSystem['/root/renamed-dir/subdir/nested.txt'].content, 'contenu nested');
    
    console.log('‚úÖ DEBIAN CONFORME: D√©placement de r√©pertoire avec contenu');
    return true;
}

/**
 * TEST 4: Erreur fichier source inexistant (message fran√ßais)
 */
function testDebianSourceNotFound() {
    console.log('üß™ TEST DEBIAN: Erreur fichier source inexistant');
    
    clearCaptures();
    const context = createTestContext();
    
    // Tenter de d√©placer un fichier inexistant
    cmdMv(['inexistant.txt', 'destination.txt'], context);
    
    // COMPORTEMENT: Message d'erreur en fran√ßais
    const captures = getCaptures();
    assertMvError(captures, /mv:.*Fichier ou dossier introuvable/, 'Fichier source inexistant');
    
    console.log('‚úÖ CONFORME: Message d\'erreur pour fichier inexistant');
    return true;
}

/**
 * TEST 5: Comportement Debian - √âcrasement silencieux de destination existante
 */
function testDebianDestinationExists() {
    console.log('üß™ TEST DEBIAN: √âcrasement silencieux destination existante');
    
    clearCaptures();
    const context = createTestContext();
    
    // Cr√©er deux fichiers
    testUtils.createTestFile(context, '/root/source.txt', 'contenu source');
    testUtils.createTestFile(context, '/root/dest.txt', 'contenu destination');
    
    // üîç DEBUG: √âtat initial
    console.log('üîç DEBUG - √âtat initial:');
    console.log('  source.txt existe:', !!context.fileSystem['/root/source.txt']);
    console.log('  dest.txt existe:', !!context.fileSystem['/root/dest.txt']);
    console.log('  source.txt contenu:', context.fileSystem['/root/source.txt']?.content);
    console.log('  dest.txt contenu:', context.fileSystem['/root/dest.txt']?.content);
    
    // COMPORTEMENT DEBIAN: mv √©crase silencieusement
    console.log('üîç DEBUG - Ex√©cution mv (√©crasement attendu)...');
    cmdMv(['source.txt', 'dest.txt'], context);
    
    // V√©rifier qu'AUCUNE erreur n'est g√©n√©r√©e (comportement Debian)
    const captures = getCaptures();
    console.log('üîç DEBUG - Captures re√ßues:');
    console.log('  Nombre total:', captures.length);
    captures.forEach((capture, index) => {
        console.log(`  [${index}] ${capture.className}: "${capture.text}"`);
    });
    
    assertMvSuccess(captures, '√âcrasement silencieux');
    
    // üîç DEBUG: √âtat final
    console.log('üîç DEBUG - √âtat final:');
    console.log('  source.txt existe encore:', !!context.fileSystem['/root/source.txt']);
    console.log('  dest.txt existe encore:', !!context.fileSystem['/root/dest.txt']);
    console.log('  dest.txt contenu final:', context.fileSystem['/root/dest.txt']?.content);
    
    // V√©rifications conformit√© Debian
    assert.fileNotExists(context, '/root/source.txt', 'Le fichier source ne doit plus exister');
    assert.fileExists(context, '/root/dest.txt', 'Le fichier destination doit toujours exister');
    
    // ESSENTIEL: Le contenu de destination doit √™tre √©cras√© par celui de source
    const finalFile = context.fileSystem['/root/dest.txt'];
    assert.equals(finalFile.content, 'contenu source', 'Le contenu destination doit √™tre √©cras√© par source');
    
    console.log('‚úÖ DEBIAN CONFORME: √âcrasement silencieux comme le vrai mv');
    return true;
}

/**
 * TEST 6: Erreur arguments insuffisants
 */
function testDebianInsufficientArgs() {
    console.log('üß™ TEST DEBIAN: Erreur arguments insuffisants');
    
    clearCaptures();
    const context = createTestContext();
    
    // Tester avec 0 argument
    cmdMv([], context);
    
    let captures = getCaptures();
    assert.isTrue(captures.length > 0, 'mv sans arguments doit afficher une erreur');
    
    clearCaptures();
    
    // Tester avec 1 seul argument
    cmdMv(['fichier.txt'], context);
    
    captures = getCaptures();
    assertMvError(captures, /mv: source et destination requises/, 'Un seul argument');
    
    console.log('‚úÖ DEBIAN CONFORME: Gestion des arguments insuffisants');
    return true;
}

/**
 * TEST 7: mv identique (source = destination)
 */
function testDebianSameFile() {
    console.log('üß™ TEST DEBIAN: mv vers le m√™me fichier');
    
    clearCaptures();
    const context = createTestContext();
    
    // Cr√©er un fichier
    testUtils.createTestFile(context, '/root/samefile.txt', 'contenu');
    
    // Essayer de le d√©placer vers lui-m√™me
    cmdMv(['samefile.txt', 'samefile.txt'], context);
    
    // COMPORTEMENT: Message sp√©cifique "m√™me fichier" en fran√ßais
    const captures = getCaptures();
    assertMvError(captures, /mv:.*sont le m√™me fichier/, 'M√™me fichier source et destination');
    
    // V√©rifier que le fichier n'a pas chang√©
    assert.fileExists(context, '/root/samefile.txt', 'Le fichier doit toujours exister');
    assert.equals(context.fileSystem['/root/samefile.txt'].content, 'contenu', 'Le contenu ne doit pas changer');
    
    console.log('‚úÖ CONFORME: D√©tection m√™me fichier');
    return true;
}

/**
 * TEST 8: Pr√©servation des m√©tadonn√©es lors du d√©placement
 */
function testDebianMetadataPreservation() {
    console.log('üß™ TEST DEBIAN: Pr√©servation des m√©tadonn√©es');
    
    clearCaptures();
    const context = createTestContext();
    
    // Cr√©er un fichier avec des m√©tadonn√©es sp√©cifiques
    const originalDate = new Date('2023-01-01T10:00:00Z');
    testUtils.createTestFile(context, '/root/metadata-test.txt', 'test contenu');
    
    const originalFile = context.fileSystem['/root/metadata-test.txt'];
    originalFile.created = originalDate;
    originalFile.accessed = originalDate;
    originalFile.owner = 'testuser';
    originalFile.group = 'testgroup';
    originalFile.permissions = '-rw-r--r--';
    
    // D√©placer le fichier
    cmdMv(['metadata-test.txt', 'moved-file.txt'], context);
    
    // V√©rifier que les m√©tadonn√©es importantes sont pr√©serv√©es
    const movedFile = context.fileSystem['/root/moved-file.txt'];
    assert.equals(movedFile.created.getTime(), originalDate.getTime(), 'Date de cr√©ation pr√©serv√©e');
    assert.equals(movedFile.accessed.getTime(), originalDate.getTime(), 'Date d\'acc√®s pr√©serv√©e');
    assert.equals(movedFile.owner, 'testuser', 'Propri√©taire pr√©serv√©');
    assert.equals(movedFile.group, 'testgroup', 'Groupe pr√©serv√©');
    assert.equals(movedFile.permissions, '-rw-r--r--', 'Permissions pr√©serv√©es');
    assert.equals(movedFile.content, 'test contenu', 'Contenu pr√©serv√©');
    
    // La date de modification doit √™tre mise √† jour
    assert.isTrue(movedFile.modified > originalDate, 'Date de modification doit √™tre mise √† jour');
    
    console.log('‚úÖ DEBIAN CONFORME: Pr√©servation m√©tadonn√©es');
    return true;
}

// Exporter les tests
export const mvDebianTests = [
    createTest('mv - Renommage simple (Debian)', testDebianSimpleRename),
    createTest('mv - D√©placement vers r√©pertoire (Debian)', testDebianMoveFileToDirectory),
    createTest('mv - D√©placement r√©pertoire entier (Debian)', testDebianMoveDirectory),
    createTest('mv - Erreur source inexistant (Debian)', testDebianSourceNotFound),
    createTest('mv - √âcrasement silencieux destination (Debian)', testDebianDestinationExists),
    createTest('mv - Erreur arguments insuffisants (Debian)', testDebianInsufficientArgs),
    createTest('mv - M√™me fichier source/dest (Debian)', testDebianSameFile),
    createTest('mv - Pr√©servation m√©tadonn√©es (Debian)', testDebianMetadataPreservation)
];

export default mvDebianTests;